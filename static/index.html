<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliWeather Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå¶Ô∏è</text></svg>">
    <style>
        :root { --primary-color: #007bff; --text-dark: #212529; --text-light: #6c757d; --bg-card: rgba(255, 255, 255, 0.9); --bg-item: rgba(240, 244, 248, 0.85); --border-color: rgba(0, 0, 0, 0.1); }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 2rem 1rem; background-color: #eef5ff; background-image: linear-gradient(to top, #70c1ff 0%, #b3e5fc 100%); transition: background-image 1s ease-in-out; }
        @keyframes slow-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .bg-sunny { background-image: linear-gradient(to top, #ffcc33 0%, #ffb347 100%); background-size: 200% 200%; animation: slow-pan 20s ease infinite; }
        .bg-cloudy { background-image: linear-gradient(to top, #bdc3c7 0%, #a7b5c1 100%); background-size: 200% 200%; animation: slow-pan 30s ease infinite; }
        .bg-snowy { background-image: linear-gradient(to top, #e6e9f0 0%, #eef1f5 100%); background-size: 200% 200%; animation: slow-pan 35s ease infinite; }
        .bg-rainy { background: linear-gradient(to bottom, #738290, #485461); color: white; }
        .rain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; }
        .rain .drop { position: absolute; bottom: 100%; width: 2px; height: 80px; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.4)); animation: drop 0.5s linear infinite; }
        @keyframes drop { 0% {transform: translateY(0vh);} 100% {transform: translateY(110vh);} }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .dashboard { background: var(--bg-card); backdrop-filter: blur(12px); padding: 2rem; border-radius: 20px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); width: 100%; max-width: 900px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .header-text h1 { margin: 0; color: var(--text-dark); font-size: 1.5rem; }
        .header-text p { margin: 0; color: var(--text-light); }
        .search-container { position: relative; }
        #city-search { font-size: 1rem; padding: 0.5rem; border-radius: 8px; border: 1px solid #ccc; width: 220px; }
        #search-results { position: absolute; background: white; width: 220px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 10; border: 1px solid #eee; }
        .search-item { padding: 0.75rem; cursor: pointer; }
        .search-item:hover { background-color: #f0f4f8; }
        #alert-banner { background: #ffc107; color: #333; font-weight: bold; padding: 1rem; text-align: center; border-radius: 10px; margin-bottom: 1rem; display: none; }
        nav { display: flex; justify-content: center; border-bottom: 1px solid var(--border-color); margin-bottom: 2rem; }
        nav button { background: none; border: none; padding: 1rem; font-size: 1rem; cursor: pointer; color: var(--text-light); border-bottom: 3px solid transparent; }
        nav button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .now-layout { display: flex; flex-wrap: wrap; gap: 2rem; align-items: center;}
        .main-display { flex: 1; min-width: 250px; text-align: center; }
        .main-display .icon { font-size: 6rem; margin: 0; }
        .main-display .temp { font-size: 5rem; font-weight: bold; margin: 0; color: var(--text-dark); line-height: 1; }
        .main-display .description { font-size: 1.5rem; color: var(--text-light); margin: 0 0 0.5rem 0; }
        .details-grid { flex: 1.5; min-width: 300px; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .detail-item { background: var(--bg-item); padding: 1rem; border-radius: 10px; }
        .detail-item h3 { margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-light); font-weight: normal; text-align: left; }
        .detail-item p { margin: 0; font-size: 1.5rem; font-weight: bold; color: var(--text-dark); text-align: left; }
        .hourly-forecast-container { display: flex; overflow-x: auto; gap: 1rem; padding-bottom: 1rem; scrollbar-width: thin; }
        .hourly-item { text-align: center; min-width: 65px; background: var(--bg-item); padding: 1rem 0.5rem; border-radius: 10px; }
        .hourly-item .time { font-size: 0.9rem; font-weight: bold; }
        .hourly-item .icon { font-size: 1.8rem; margin: 0.5rem 0; }
        .hourly-item .temp { font-weight: 500; font-size: 1.1rem; }
        .daily-forecast-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .forecast-item { display: grid; grid-template-columns: 1fr 1fr 2fr 1.5fr; align-items: center; padding: 0.75rem; border-radius: 10px; transition: background-color 0.2s; }
        .forecast-item:hover { background-color: var(--bg-item); }
        .forecast-item > div { text-align: left; }
        .forecast-item .day { font-weight: bold; }
        .forecast-item .icon { font-size: 1.5rem; text-align: center; }
        .forecast-item .precip { color: #36a2eb; font-size: 0.9rem; }
        .forecast-item .temps { font-weight: 500; text-align: right; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div id="alert-banner"></div>
        <div class="header">
            <div class="header-text">
                <h1 id="location-name">IntelliWeather</h1>
                <p id="current-date"></p>
            </div>
            <div class="search-container">
                <input type="text" id="city-search" placeholder="Search for a city...">
                <div id="search-results"></div>
            </div>
        </div>
        
        <nav>
            <button class="tab-button active" data-tab="now">Now</button>
            <button class="tab-button" data-tab="hourly">Hourly</button>
            <button class="tab-button" data-tab="daily">Daily</button>
        </nav>
        
        <div id="now" class="tab-content active">
            <div class="now-layout">
                <div class="main-display">
                    <p class="icon" id="main-icon">--</p>
                    <p class="temp" id="main-temp">--¬∞</p>
                    <p class="description" id="weather-description">--</p>
                </div>
                <div class="details-grid">
                    <div class="detail-item"><h3>Feels Like</h3><p id="feels-like">--¬∞</p></div>
                    <div class="detail-item"><h3>Humidity</h3><p id="humidity">--%</p></div>
                    <div class="detail-item"><h3>Wind</h3><p id="wind">-- m/s</p></div>
                    <div class="detail-item"><h3>UV Index</h3><p id="uv-index">--</p></div>
                    <div class="detail-item"><h3>Air Quality (AQI)</h3><p id="aqi">--</p></div>
                    <div class="detail-item"><h3>Precipitation</h3><p id="precip-sum">-- mm</p></div>
                </div>
            </div>
        </div>
        
        <div id="hourly" class="tab-content"><div class="hourly-forecast-container" id="hourly-forecast-container"></div></div>
        
        <div id="daily" class="tab-content"><div class="daily-forecast-list" id="daily-forecast-container"></div></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Use same-origin relative paths so the frontend works in hosted previews
            // and when the app is served from a proxied URL (e.g. Codespaces/Cloud).
            const API_BASE_URL = "";
            let lastCoords = { lat: null, lon: null, name: "Your Location" };

            // --- ALL DOM SELECTORS ---
            const locationNameEl = document.getElementById('location-name');
            const searchInput = document.getElementById('city-search');
            const searchResults = document.getElementById('search-results');
            const tabs = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            // --- EVENT LISTENERS ---
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => item.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });

            let searchTimeout;
            searchInput.addEventListener('keyup', () => {
                clearTimeout(searchTimeout);
                const query = searchInput.value;
                if (query.length < 3) { searchResults.innerHTML = ''; return; }
                searchTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=5`);
                        const data = await response.json();
                        searchResults.innerHTML = '';
                        if (data.results) {
                            data.results.forEach(city => {
                                const item = document.createElement('div');
                                item.className = 'search-item';
                                item.textContent = `${city.name}, ${city.admin1 || ''} ${city.country_code}`;
                                item.onclick = () => {
                                    fetchAllWeatherData(city.latitude, city.longitude, city.name);
                                    searchResults.innerHTML = '';
                                    searchInput.value = '';
                                };
                                searchResults.appendChild(item);
                            });
                        }
                    } catch (e) { console.error("Geocoding failed:", e); }
                }, 500);
            });

            // --- DATA FETCHING & UI ORCHESTRATION ---
            async function fetchAllWeatherData(lat, lon, name) {
                lastCoords = { lat, lon, name };
                locationNameEl.innerHTML = `<span style="animation: pulse 1.5s ease-in-out infinite;">‚è≥ Loading weather for ${name}...</span>`;
                
                console.log(`üîÑ Fetching weather data for ${name} at ${lat}, ${lon}`);
                const startTime = Date.now();

                try {
                    // Fetch with timeout to prevent hanging
                    const fetchWithTimeout = (url, timeout = 15000) => {
                        return Promise.race([
                            fetch(url),
                            new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Request timeout')), timeout)
                            )
                        ]);
                    };

                    const [weatherRes, hourlyRes, dailyRes, aqiAlertsRes] = await Promise.allSettled([
                        fetchWithTimeout(`${API_BASE_URL}/weather?lat=${lat}&lon=${lon}`),
                        fetchWithTimeout(`${API_BASE_URL}/hourly?lat=${lat}&lon=${lon}`),
                        fetchWithTimeout(`${API_BASE_URL}/forecast?lat=${lat}&lon=${lon}`),
                        fetchWithTimeout(`${API_BASE_URL}/aqi-alerts?lat=${lat}&lon=${lon}`)
                    ]);
                    
                    // Extract successful responses or null
                    const weatherData = weatherRes.status === 'fulfilled' && weatherRes.value.ok ? await weatherRes.value.json() : null;
                    const hourlyData = hourlyRes.status === 'fulfilled' && hourlyRes.value.ok ? await hourlyRes.value.json() : [];
                    const dailyData = dailyRes.status === 'fulfilled' && dailyRes.value.ok ? await dailyRes.value.json() : [];
                    const aqiAlertsData = aqiAlertsRes.status === 'fulfilled' && aqiAlertsRes.value.ok ? await aqiAlertsRes.value.json() : {aqi: null, alerts: []};
                    
                    console.log(`üì° API Results: weather=${weatherRes.status}, hourly=${hourlyRes.status}, daily=${dailyRes.status}, aqi=${aqiAlertsRes.status}`);
                    
                    if (!weatherData) throw new Error('Weather data unavailable (timeout or error)');

                    const loadTime = Date.now() - startTime;
                    console.log('üì¶ Received data:', { 
                        weather: weatherData ? 'OK' : 'FAILED', 
                        hourly: (hourlyData && hourlyData.length) ? hourlyData.length + ' hours' : 'FAILED',
                        daily: (dailyData && dailyData.length) ? dailyData.length + ' days' : 'FAILED',
                        aqi: aqiAlertsData && aqiAlertsData.aqi ? 'OK' : 'FAILED'
                    });

                    updateUI(name, weatherData, hourlyData, dailyData, aqiAlertsData);
                    console.log(`‚úÖ UI updated successfully in ${loadTime}ms!`);
                } catch (error) {
                    console.error("‚ùå Failed to fetch weather data:", error);
                    locationNameEl.innerHTML = `Failed to load data.<br><small style="font-size:0.8rem; color:red;">${error.message}</small>`;
                    
                    // Show helpful hint if connection failed
                    if (error.message.includes("Failed to fetch") || error.message.includes("NetworkError")) {
                         document.getElementById('alert-banner').style.display = 'block';
                         document.getElementById('alert-banner').innerHTML = `
                            <strong>Connection Failed!</strong><br>
                            Make sure the backend is running on port 8000.<br>
                            If you are using "Live Server", please open the link from the terminal instead (http://localhost:8000).
                         `;
                    }
                }
            }

            function updateUI(name, current, hourly, daily, aqiAlerts) {
                locationNameEl.textContent = name;
                if (current && current.weather_code) updateBackground(current.weather_code);
                if (aqiAlerts && aqiAlerts.alerts) updateAlertsUI(aqiAlerts.alerts);
                if (current && daily && daily[0]) updateCurrentWeatherUI(current, daily[0]);
                if (hourly && hourly.length > 0) renderHourlyForecast(hourly);
                if (daily && daily.length > 0) updateDailyForecastUI(daily);
                if (aqiAlerts && aqiAlerts.aqi) updateAqiUI(aqiAlerts.aqi);
            }

            // --- UI UPDATE FUNCTIONS ---
            function updateCurrentWeatherUI(current, today) {
                if (!current) return;
                document.getElementById('main-icon').textContent = getWeatherIcon(current.weather_code || 0);
                document.getElementById('main-temp').textContent = `${Math.round(current.temperature_c || 0)}¬∞`;
                document.getElementById('weather-description').textContent = getWeatherDescription(current.weather_code || 0);
                document.getElementById('feels-like').textContent = `${Math.round(current.apparent_temperature || 0)}¬∞`;
                document.getElementById('humidity').textContent = `${current.humidity_pct || 0}%`;
                document.getElementById('wind').textContent = `${current.wind_speed_mps || 0} m/s`;
                document.getElementById('uv-index').textContent = current.uv_index || 0;
                document.getElementById('precip-sum').textContent = `${today && today.precipitation_sum !== undefined ? today.precipitation_sum : 0} mm`;
            }

            function renderHourlyForecast(data) {
                const container = document.getElementById('hourly-forecast-container');
                container.innerHTML = '';
                if (!data || data.length === 0) {
                    container.innerHTML = '<div style="padding:1rem; color:#888;">Hourly data unavailable</div>';
                    return;
                }
                data.slice(0, 24).forEach(hour => {
                    const item = document.createElement('div');
                    item.className = 'hourly-item';
                    item.innerHTML = `
                        <div class="time">${new Date(hour.time).getHours()}:00</div>
                        <div class="icon">${getWeatherIcon(hour.weather_code || 0)}</div>
                        <div class="temp">${Math.round(hour.temp || 0)}¬∞</div>
                    `;
                    container.appendChild(item);
                });
            }

            function updateDailyForecastUI(data) {
                const container = document.getElementById('daily-forecast-container');
                container.innerHTML = '';
                if (!data || data.length === 0) {
                    container.innerHTML = '<div style="padding:1rem; color:#888;">Forecast data unavailable</div>';
                    return;
                }
                data.forEach(day => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'forecast-item';
                    const date = new Date(day.date);
                    itemEl.innerHTML = ` <div class="day">${date.toLocaleDateString('en-US', { weekday: 'short' })}</div> <div class="icon">${getWeatherIcon(day.weather_code || 0)}</div> <div class="precip">üíß ${day.precipitation_probability_max || 0}%</div> <div class="temps">${Math.round(day.min_temp || 0)}¬∞ / <strong>${Math.round(day.max_temp || 0)}¬∞</strong></div> `;
                    container.appendChild(itemEl);
                });
            }

            function updateAlertsUI(alerts) {
                const banner = document.getElementById('alert-banner');
                if (alerts && alerts.length > 0) {
                    banner.textContent = `‚ö†Ô∏è Alert: ${alerts[0]}`;
                    banner.style.display = 'block';
                } else {
                    banner.style.display = 'none';
                }
            }

            function updateAqiUI(data) {
                const aqiEl = document.getElementById('aqi');
                if(!data || !data.hourly || !data.hourly.us_aqi || data.hourly.us_aqi.length === 0) {
                    aqiEl.textContent = 'N/A';
                    return;
                };
                aqiEl.textContent = data.hourly.us_aqi[0];
            }

            // --- HELPER FUNCTIONS ---
            function updateBackground(code) {
                const condition = getWeatherCondition(code);
                document.body.className = '';
                document.body.classList.add(condition);
                let existingRain = document.querySelector('.rain');
                if (existingRain) existingRain.remove();
                if (condition === 'bg-rainy') {
                    const rain = document.createElement('div');
                    rain.className = 'rain';
                    for (let i = 0; i < 70; i++) {
                        const drop = document.createElement('div');
                        drop.className = 'drop';
                        drop.style.left = `${Math.random() * 100}%`;
                        drop.style.animationDelay = `${Math.random() * 2}s`;
                        drop.style.animationDuration = `${0.2 + Math.random() * 0.3}s`;
                        rain.appendChild(drop);
                    }
                    document.body.prepend(rain);
                }
            }

            function getWeatherDescription(code) { const d = { 0: 'Clear', 1: 'Mainly Clear', 2: 'Partly Cloudy', 3: 'Overcast', 45: 'Fog', 48: 'Rime Fog', 61: 'Slight Rain', 63: 'Rain', 65: 'Heavy Rain', 80: 'Rain Showers', 95: 'Thunderstorm' }; return d[code] || 'Cloudy'; }
            function getWeatherIcon(code) { const c = getWeatherCondition(code); if (c === 'bg-sunny') return '‚òÄÔ∏è'; if (c === 'bg-cloudy') return '‚òÅÔ∏è'; if (c === 'bg-rainy') return 'üåßÔ∏è'; if (c === 'bg-snowy') return '‚ùÑÔ∏è'; return 'üåç'; }
            function getWeatherCondition(code) { if (code <= 1) return 'bg-sunny'; if (code <= 3) return 'bg-cloudy'; if (code > 40) return 'bg-rainy'; return 'bg-cloudy'; }

            // --- AUTO-REFRESH ---
            setInterval(() => { if (lastCoords.lat) { fetchAllWeatherData(lastCoords.lat, lastCoords.lon, lastCoords.name); } }, 15 * 60 * 1000);

            // --- INITIAL LOAD ---
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => fetchAllWeatherData(position.coords.latitude, position.coords.longitude, "Your Current Location"),
                    () => { alert('Could not get your location. Please use the search bar.'); }
                );
            } else {
                alert('Geolocation is not supported. Please use the search bar.');
            }
        });
    </script>
</body>
</html>
